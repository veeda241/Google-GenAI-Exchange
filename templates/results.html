<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Career Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="currentColor" class="icon">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Start Over
        </a>
        
        <header class="main-header">
            <h1>Your Career Analysis</h1>
            <p>Based on your skills, here are our top recommendations for your next career move.</p>
        </header>

        <div class="card">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" style="vertical-align: -4px; margin-right: 8px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
                Identified Skills
            </h2>
            {% if analysis.user_skills %}
                <ul class="skills-list">
                    {% for skill in analysis.user_skills %}
                        <li>{{ skill }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No specific skills identified. Try providing more detail in your summary.</p>
            {% endif %}
        </div>

        <h2>Top Career Recommendations</h2>
        {% for rec in analysis.recommendations %}
        <div class="card expandable-card {% if loop.first %}expanded{% endif %}">
            <div class="card-header expandable-header">
                <h3>{{ rec.career.title }}</h3>
                <div class="card-header-right">
                    <div class="score-badge">{{ "%.0f"|format(rec.score * 100) }}% Match</div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="chevron-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
            <p>{{ rec.career.description }}</p>
            
            <div class="recommendation-details">
                {% if rec.skill_gap or rec.career.project_ideas_detailed or rec.career.project_ideas %}
                    {% if rec.skill_gap %}
                        <h4>
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                            </svg>
                            Skill Gap
                        </h4>
                        <p>To excel in this role, consider learning the following:</p>
                        <ul class="skills-list gap">
                            {% for skill in rec.skill_gap %}
                                <li>{{ skill }}</li>
                            {% endfor %}
                        </ul>

                        {% if rec.course_recommendations %}
                            <h4 style="margin-top: 1.5rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path d="M12 14l9-5-9-5-9 5 9 5z" />
                                    <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-5.998 12.078 12.078 0 01.665-6.479L12 14z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-5.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222 4 2.222V20" />
                                </svg>
                                Recommended Courses
                            </h4>
                            <ul>
                                {% for course in rec.course_recommendations %}
                                    <li>
                                        <a href="{{ course.url }}" target="_blank">{{ course.title }}</a>
                                        <span class="provider">({{ course.provider }})</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% endif %}

                    <div class="projects-section">
                        {% if rec.career.project_ideas_detailed %}
                            <h4 style="margin-top: 1.5rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Project Ideas to Build Your Portfolio
                            </h4>
                            <div class="project-ideas-grid">
                                {% for project in rec.career.project_ideas_detailed %}
                                    <div class="project-card">
                                        <div class="video-embed-container">
                                            <iframe 
                                                src="https://www.youtube.com/embed/{{ project.id }}" 
                                                title="{{ project.title }}" 
                                                frameborder="0" 
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                allowfullscreen>
                                            </iframe>
                                        </div>
                                        <h5>{{ project.title }}</h5>
                                        {% if project.view_count %}
                                        <p class="video-stats">{{ "{:,.0f}".format(project.view_count|int) }} views</p>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% elif rec.career.project_ideas %}
                            <!-- Fallback to simple list if detailed projects aren't available -->
                            <ul>
                                {% for project in rec.career.project_ideas %}
                                    <li>
                                        <a href="{{ project.youtube_url }}" target="_blank">{{ project.name }}</a>
                                        <span class="provider">(YouTube Tutorial/Guide)</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}

                        <h4 style="margin-top: 2.5rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            Find More Project Ideas
                        </h4>
                        <p>Search for other tutorials and projects on YouTube.</p>
                        <div class="search-container">
                            <input type="text" class="youtube-search-input" placeholder="e.g., 'Build a REST API with Flask'">
                            <button class="youtube-search-button">Search</button>
                        </div>
                        <div class="search-spinner" style="display: none; text-align: center; padding: 2rem;">
                            <p>Searching...</p>
                        </div>
                        <div class="youtube-search-results project-ideas-grid">
                        </div>
                    </div>
                {% else %}
                    <p style="margin-top: 1.5rem; color: var(--text-secondary);">You have all the required skills for this role! Consider building some projects to strengthen your portfolio.</p>
                {% endif %}
            </div>
        </div>
        {% else %}
            <div class="card">
                <p>Could not generate recommendations based on the provided input. Try providing a more detailed summary of your skills and experience.</p>
            </div>
        {% endfor %}

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Accordion Logic ---
            const allCards = document.querySelectorAll('.expandable-card');
            allCards.forEach(card => {
                const header = card.querySelector('.expandable-header');
                const content = card.querySelector('.recommendation-details');

                // Set initial state based on 'expanded' class
                if (!card.classList.contains('expanded')) {
                    content.style.display = 'none';
                }

                header.addEventListener('click', () => {
                    const isExpanded = card.classList.contains('expanded');

                    // Close all other cards
                    allCards.forEach(otherCard => {
                        otherCard.classList.remove('expanded');
                        otherCard.querySelector('.recommendation-details').style.display = 'none';
                    });

                    // Toggle the clicked card
                    if (!isExpanded) {
                        card.classList.add('expanded');
                        content.style.display = 'block';
                    }
                });
            });

            // --- YouTube Search Logic ---
            const performSearch = async (searchButton) => {
                const parentDetails = searchButton.closest('.recommendation-details');
                const searchInput = parentDetails.querySelector('.youtube-search-input');
                const resultsContainer = parentDetails.querySelector('.youtube-search-results');
                const spinner = parentDetails.querySelector('.search-spinner');

                const query = searchInput.value.trim();
                if (!query) {
                    resultsContainer.innerHTML = '<p style="color: var(--text-secondary);">Please enter a search term.</p>';
                    return;
                }
    
                spinner.style.display = 'block';
                resultsContainer.innerHTML = '';
    
                try {
                    const response = await fetch('/search_videos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: query }),
                    });
    
                    spinner.style.display = 'none';
                    if (!response.ok) throw new Error('Network response was not ok');
    
                    const videos = await response.json();
                    if (videos.length === 0) {
                        resultsContainer.innerHTML = '<p style="color: var(--text-secondary);">No videos found for your search.</p>';
                        return;
                    }
    
                    videos.forEach(video => {
                        const videoCard = `
                            <div class="project-card">
                                <div class="video-embed-container">
                                    <iframe src="https://www.youtube.com/embed/${video.id}" title="${video.title}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                                <h5>${video.title}</h5>
                            </div>
                        `;
                        resultsContainer.innerHTML += videoCard;
                    });
                } catch (error) {
                    spinner.style.display = 'none';
                    resultsContainer.innerHTML = '<p style="color: var(--danger-color);">An error occurred while searching. Please try again.</p>';
                    console.error('Search error:', error);
                }
            };

            document.querySelectorAll('.youtube-search-button').forEach(button => {
                button.addEventListener('click', () => performSearch(button));
            });

            document.querySelectorAll('.youtube-search-input').forEach(input => {
                input.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        performSearch(event.target);
                    }
                });
            });
        });
    </script>
</body>
</html>